name: DB_BACKUP

on:
  push:
  schedule:
    - cron: "0 2 * * 0"

jobs:
  backup:

    name: DB_BACKUP
    runs-on: ubuntu-latest

    steps:
      - name: SSH Remote Commands from ci/cd server
        uses: garygrossgarten/github-action-ssh@release
        with:
          host: ${{ secrets.CICD_HOST }}
          username: ${{ secrets.CICD_USERNAME }}
          password: ${{ secrets.CICD_PASSWORD }}
          command: |
            DB=$(kubectl get pod -n prod-hrebs | grep master | cut -d ' ' -f1)
            kubectl exec -it -n prod-hrebs $DB -- ls -al /docker-entrypoint-initdb.d/
            # mysqldump -u {{ secrets.DATABASE_USER }} -p {{ secrets.DATABASE_PASSWORD }} {{ secrets.DATABASE_USER }}  --ignore-table={{ secrets.DATABASE_USER }}.django_migrations > /docker-entrypoint-initdb.d/backup.sql
